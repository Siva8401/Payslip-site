<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bloom Payslip Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; padding: 30px; }
    .card { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08); }
    h1 { text-align: center; color: #e63946; }
    label { display: block; margin-top: 14px; font-weight: 600; }
    select, input, button {
      width: 100%; padding: 10px; font-size: 1rem; margin-top: 6px;
      border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;
    }
    button {
      background: #e63946; color: white; border: none; font-weight: 600; cursor: pointer;
      margin-top: 18px;
    }
    button:hover { background: #d62828; }
    .hidden { display: none; }
    .message { color: #e63946; font-weight: 500; margin-top: 10px; }
    .success { color: green; }
    .payslip { background: #f9fafb; padding: 20px; margin-top: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.03); }
    .inline { display: inline-block; margin-right: 20px; }
  </style>
</head>
<body>
<div class="card">
  <h1>üßæ Employee Payslip Portal</h1>

  <!-- Login Form -->
  <div id="loginView">
    <label>Employee ID</label>
    <select id="employeeId"><option>Loading...</option></select>

    <label>Username</label>
    <input type="text" id="username" placeholder="Enter Username" />

    <label>Password</label>
    <input type="password" id="password" placeholder="Enter Password" />

    <button onclick="handleLogin()">Login</button>
    <div class="message" id="loginMessage"></div>
  </div>

  <!-- Pay Period View -->
  <div id="payPeriodView" class="hidden">
    <label>Select Pay Period</label>
    <select id="payPeriod"><option>-- Select --</option></select>
    <button onclick="loadPayslip()">View Payslip</button>
  </div>

  <!-- Payslip Display -->
  <div id="payslipView" class="hidden">
    <div class="payslip" id="payslipDisplay"></div>
    <button onclick="downloadPDF()">‚¨á Download PDF</button>
    <button onclick="showPasswordChange()">Change Password</button>
    <button onclick="logout()" style="background:#666">Logout</button>
  </div>

  <!-- Password Update Form -->
  <div id="passwordUpdate" class="hidden">
    <label>New Password</label>
    <input type="password" id="newPassword" />
    <label>Confirm Password</label>
    <input type="password" id="confirmPassword" />
    <button onclick="updatePassword()">Update Password</button>
    <div class="message" id="updateMsg"></div>
  </div>
</div>

<script>
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQrLihmERkwNQcGyoYcEnpWBu732YOewgCZgjt6ylykJd0Mc68tETA3gh_MsmylaYfyHl6EvP7Taeee/pub?output=csv';
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxHs1Zb6ZHY6MhVbdsxPwwrV4glF8YzrmlLNdTLvW0sxElfmKoKmayVZlYw0nRzWOPqCg/exec';
  const SECRET_KEY = 'mccSecure2025';

  let sheetData = [];
  let currentUser = null;

  // Load CSV and populate Employee ID dropdown
  fetch(CSV_URL)
    .then(res => res.text())
    .then(csv => {
      const [header, ...rows] = csv.trim().split('\n').map(r => r.split(','));
      const headers = header.map(h => h.trim());
      sheetData = rows.map(row => {
        const values = {};
        headers.forEach((h, i) => values[h] = row[i] ? row[i].trim() : '');
        return values;
      });

      const empIds = [...new Set(sheetData.map(r => r["Employee ID"]).filter(Boolean))];
      const dropdown = document.getElementById('employeeId');
      dropdown.innerHTML = '<option value="">-- Select ID --</option>';
      empIds.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id; opt.textContent = id;
        dropdown.appendChild(opt);
      });
    });

  function handleLogin() {
    const empId = document.getElementById('employeeId').value;
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    const match = sheetData.find(r =>
      r["Employee ID"] === empId &&
      r["Username"]?.toLowerCase() === username.toLowerCase() &&
      r["Password"] === password
    );

    const msg = document.getElementById('loginMessage');
    if (!match) {
      msg.textContent = "üö´ Invalid credentials.";
      return;
    }

    msg.textContent = "";
    currentUser = match;

    // Show pay periods available
    const periods = sheetData
      .filter(r => r["Employee ID"] === empId)
      .map(r => `${r["Month"]}-${r["Year"]}`);

    const paySelect = document.getElementById('payPeriod');
    paySelect.innerHTML = '<option value="">-- Select --</option>';
    [...new Set(periods)].forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      paySelect.appendChild(opt);
    });

    document.getElementById('loginView').classList.add('hidden');
    document.getElementById('payPeriodView').classList.remove('hidden');
  }

  function loadPayslip() {
    const [month, year] = document.getElementById('payPeriod').value.split('-');
    const record = sheetData.find(r =>
      r["Employee ID"] === currentUser["Employee ID"] &&
      r["Month"] === month && r["Year"] === year);

    if (!record) return alert('Payslip not found.');

    const box = document.getElementById('payslipDisplay');
    box.innerHTML = `
      <h3>${record["Employee Name"] || ''} ‚Äì ${month}-${year}</h3>
      <p><strong>Designation:</strong> ${record["Designation"] || ''}</p>
      <p><strong>Take Home:</strong> ‚Çπ${record["TAKEHOME"] || record["Takehome"] || '0'}</p>
      <p><strong>Project:</strong> ${record["Project"] || '-'}</p>
      <p><strong>Worked Days:</strong> ${record["Worked Days"] || '-'} | <strong>LOP:</strong> ${record["LOP Days"] || '-'}</p>
      <p><strong>Gross:</strong> ‚Çπ${record["GROSS EARNINGS"] || '-'} | <strong>PF:</strong> ‚Çπ${record["PF"] || '-'} | <strong>PT:</strong> ‚Çπ${record["PT"] || '-'}</p>
      <p><strong>Salary in Words:</strong> ${record["SALARY WORDS"] || '-'}</p>
    `;

    document.getElementById('payPeriodView').classList.add('hidden');
    document.getElementById('payslipView').classList.remove('hidden');
  }

  function downloadPDF() {
    const ele = document.getElementById('payslipDisplay');
    html2pdf().from(ele).set({ filename: `payslip_${currentUser["Employee ID"]}.pdf` }).save();
  }

  function showPasswordChange() {
    document.getElementById("passwordUpdate").classList.remove('hidden');
  }

  function updatePassword() {
    const newP = document.getElementById("newPassword").value.trim();
    const confirmP = document.getElementById("confirmPassword").value.trim();
    const msgEl = document.getElementById("updateMsg");

    if (!newP || !confirmP || newP !== confirmP) {
      msgEl.textContent = "‚ö†Ô∏è Passwords do not match or are empty.";
      return;
    }

    const url = `${SCRIPT_URL}?name=${encodeURIComponent(currentUser["Username"])}&newPassword=${encodeURIComponent(newP)}&key=${SECRET_KEY}`;
    fetch(url)
    .then(res => res.text())
    .then(msg => {
      msgEl.textContent = msg.includes("Success") ? "‚úÖ Password updated!" : `‚ùå ${msg}`;
    })
    .catch(() => msgEl.textContent = "‚ùå Error connecting to server.");
  }

  function logout() {
    currentUser = null;
    document.getElementById("loginView").classList.remove("hidden");
    document.getElementById("payPeriodView").classList.add("hidden");
    document.getElementById("payslipView").classList.add("hidden");
    document.getElementById("passwordUpdate").classList.add("hidden");
    document.getElementById("username").value = '';
    document.getElementById("password").value = '';
  }
</script>
</body>
</html>
